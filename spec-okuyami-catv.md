# お悔やみ情報 CATV配信システム 仕様書

## 1. プロジェクト概要

### 背景
- 都留市役所がお悔やみ情報をサンニチ新聞にメールで送付している
- サンニチ新聞はそれを元に新聞のお悔やみ欄を掲載している
- 同じ情報をCATVでも配信したいという要望がある

### 目的
市役所から送信されるお悔やみ情報を自動的にパワーポイントに変換し、CATVで放映できる形式で配信する

---

## 2. システムフロー

### 全体フロー

```
ステップ1: 市役所
  └→ お悔やみ情報（PDF添付）を指定メールアドレスに送信

ステップ2: システム（自動処理）
  └→ メール受信
  └→ 添付PDFを解析
  └→ お悔やみ情報を抽出
  └→ パワーポイントを自動生成
  └→ 市担当者にメール通知

ステップ3: 市担当者（確認・承認）
  └→ 管理画面にログイン
  └→ 生成されたパワーポイントをプレビュー
  └→ 内容確認
      ├→ OK: 承認ボタンをクリック
      └→ NG: ダウンロード → 手動修正 → 再アップロード → 承認

ステップ4: CATV配信
  └→ 承認後、システムが自動でCATVにメール送信
  └→ パワーポイントファイルを添付
```

### 担当者確認フロー詳細

#### 通常時（修正不要の場合）
1. システムからメール通知を受信
2. 管理画面にログイン
3. パワーポイントをプレビュー
4. 「承認」ボタンをクリック
5. CATVへ自動送信

#### 修正が必要な場合
1. システムからメール通知を受信
2. 管理画面にログイン
3. パワーポイントをプレビュー
4. パワーポイントをダウンロード
5. PowerPointで手動修正
6. 修正済みファイルを管理画面から再アップロード
7. 「承認」ボタンをクリック
8. CATVへ自動送信

---

## 3. 入力仕様

### メールフォーマット

- **送信元**: 市役所担当者
- **送信先**: システム指定のメールアドレス（例: okuyami@example.com）
- **件名**: お悔やみ情報 YYYY/MM/DD
- **添付ファイル**: okuyami_YYYYMMDD.pdf

### PDF内容（表形式）

| 故人名 | 年齢 | 喪主名 | 続柄 | 通夜 | 告別式 | 会場 |
|-------|-----|-------|-----|------|-------|-----|
| 山田 太郎 | 85歳 | 山田 花子 | 妻 | 1/15 18:00 | 1/16 10:00 | ○○斎場 |
| 鈴木 一郎 | 78歳 | 鈴木 次郎 | 長男 | 1/15 19:00 | 1/16 11:00 | △△会館 |

### 掲載項目

1. 故人名
2. 年齢
3. 喪主名
4. 喪主続柄（妻、長男、など）
5. 通夜日時
6. 告別式日時
7. 会場

※ ふりがな、住所は含めない

---

## 4. 出力仕様

### パワーポイント

- **形式**: .pptx
- **レイアウト**: 1スライドに複数名を表形式で表示
- **スライド分割**: 人数が多い場合は複数スライドに自動分割

### CATVへの送信メール

- **送信先**: CATV指定のメールアドレス（固定）
- **件名**: 指定フォーマット（要決定）
- **本文**: 指定フォーマット（要決定）
- **添付ファイル**: 生成されたパワーポイント

---

## 5. 管理画面機能

### 認証
- ログイン機能（市担当者用）
- アカウント管理

### 主要機能
1. **受信履歴一覧**: メール受信の履歴を表示
2. **パワポプレビュー**: 生成されたパワーポイントを画面上で確認
3. **承認機能**: 承認ボタンでCATVへ送信
4. **手動アップロード**: 修正済みパワーポイントのアップロード
5. **送信履歴**: CATVへの送信履歴を表示

---

## 6. 運用仕様

### 頻度
- 1日1回、毎日

### 関係者
- **市役所**: お悔やみ情報の作成・送信
- **市担当者**: パワーポイントの確認・承認
- **CATV**: パワーポイントを画面に表示して放映

---

## 7. システム構成

### 技術スタック

| コンポーネント | 技術 |
|--------------|------|
| メール受信 | AWS SES / Mailgun / 自前メールサーバー |
| バックエンド | Laravel (PHP) |
| パワポ生成 | python-pptx (Python) |
| 管理画面 | Laravel + Blade / Vue.js |
| データベース | MySQL |
| インフラ | AWS (EC2 or Lambda) / VPS |

### PDF解析
- ライブラリ: PyMuPDF / pdfplumber
- PDFから表形式のデータを抽出

---

## 8. 登場人物・システム

### アクター
1. **市役所**: お悔やみ情報の発信元
2. **システム**: メール受信・PDF解析・パワポ生成・送信を自動処理
3. **市担当者**: パワーポイントの確認・承認を行う人
4. **CATV**: パワーポイントを受け取り放映する

### データフロー
```
市役所 --[PDF添付メール]--> システム --[パワポ生成]--> 市担当者 --[承認]--> CATV
```

---

## 9. 未決定事項

- サンプルPDFのフォーマット詳細
- パワーポイントのデザイン・レイアウト詳細
- 1スライドあたりの最大掲載人数
- 市担当者のログインアカウント数
- CATVへの送信メール件名・本文フォーマット
